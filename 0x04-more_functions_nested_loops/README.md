This is a nested loop function
